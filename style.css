// --- Vari√°veis Globais e Configura√ß√µes ---
const CORRECT_COUPON = 'MARCELO';
const DISCOUNT_PERCENTAGE = 0.30; // 30%
const TIMER_START_SECONDS = 7 * 60; // 7 minutos
const PIX_KEY = '81997777361'; 
const INSTAGRAM_USERNAME = 'marcelinho_zzs';
const INSTAGRAM_MESSAGE = 'COMPREI O HS + HOLOGRAMA';

// CONSTANTES DE CONTE√öDO PARA MODAL DE ATEN√á√ÉO (NOVO)
const HS_PROOF_VIDEO_ID = '_CIaKvuol7s';
const HS_PROOF_VIDEO_TITLE = 'PROVANDO QUE ESSE PRODUTO √â BOM E 100% ANT BAN E ANT BLACKLIST';
const VIP_PROOF_VIDEO_ID = 'rzVXUNIgt1w'; // Novo v√≠deo para o Painel VIP
const VIP_PROOF_VIDEO_TITLE = 'XITANDO EM APOSTADO COM ESSE PAINEL VIP'; // Novo t√≠tulo

// Tabela de pre√ßos din√¢micos por dia (Seu pedido)
const DAY_PRICES = {
    1: 5.0, 2: 6.0, 3: 8.0, 4: 10.0, 5: 13.0, 6: 15.0, 7: 18.0, 8: 20.0, 9: 22.0, 10: 24.0,
    11: 26.0, 12: 28.0, 13: 30.0, 14: 31.0, 15: 32.0, 16: 34.0, 17: 36.0, 18: 38.0, 19: 39.0, 20: 40.0,
    21: 42.0, 22: 44.0, 23: 46.0, 24: 48.0, 25: 50.0, 26: 51.0, 27: 52.0, 28: 53.0, 29: 55.0, 30: 60.0
};

const INITIAL_PRODUCT_PRICE = 30.00;
let currentProductPrice = INITIAL_PRODUCT_PRICE;
let finalPaymentPrice = 0;
let daysSelected = 0;

// Vari√°vel para rastrear qual produto est√° ativo na compra
let activeProduct = 'HS'; // 'HS' (Pesco√ßo) ou 'VIP' (Painel)

// Cria o link de deep link
const INSTAGRAM_LINK_DIRECT = `https://ig.me/m/${INSTAGRAM_USERNAME}?ref=COMPRA-SITE&text=${encodeURIComponent(INSTAGRAM_MESSAGE)}`;


// --- Seletores DOM ---
const timerDisplay = document.getElementById('timer-display');
const countdownTimer = document.getElementById('countdown-timer');
const priceIndicator = document.querySelector('.price-indicator'); 

// Cupom
const couponInput = document.getElementById('coupon-input');
const couponMessage = document.getElementById('coupon-message');
const applyCouponBtn = document.getElementById('apply-coupon-btn');

// Modals e Bot√µes
const startPurchaseBtn = document.getElementById('start-purchase-btn'); // Bot√£o do HS PESCO√áO
const startVipPurchaseBtn = document.getElementById('start-vip-purchase-btn'); // NOVO: Bot√£o do PAINEL VIP
const attentionModal = document.getElementById('attention-modal');
const closeBtns = document.querySelectorAll('.close-btn');
const confirmModalBtn = document.getElementById('confirm-modal-btn');
const durationModal = document.getElementById('duration-modal');
const durationInput = document.getElementById('duration-input');
const durationValidationMessage = document.getElementById('duration-validation-message');
const paymentStepContent = document.getElementById('payment-step-content');
const finalPriceElement = document.getElementById('final-price');

// Pagamento
const copyPixBtn = document.getElementById('copy-pix-btn');
const copyFeedback = document.getElementById('copy-feedback');
const bankInfoDiv = document.getElementById('bank-info');
const instagramInstructions = document.getElementById('instagram-instructions');
const openInstagramBtn = document.getElementById('open-instagram-btn');

// Elementos do Modal de Aten√ß√£o para altera√ß√£o din√¢mica
const proofVideoIframe = document.querySelector('#attention-modal .proof-video-card iframe');
const proofTitleElement = document.querySelector('#attention-modal .proof-video-card .proof-title');

// Prova Social
const socialProofContainer = document.getElementById('social-proof-messages');

// 50 Nomes para Prova Social (CRIADOS POR GEMINI)
const SOCIAL_PROOF_NAMES = [
    "Gabriel Santana", "Lucas Oliveira", "Maria Eduarda", "Pedro Costa", "Ana Luiza", 
    "Jo√£o Victor", "Isabela Lima", "Matheus Rocha", "Sofia Gomes", "Felipe Souza",
    "Laura Mendes", "Daniel Pereira", "Beatriz Alves", "Guilherme Nunes", "Julia Ferreira",
    "Rafael Martins", "Larissa Ribeiro", "Thiago Carvalho", "Manuela Silveira", "Alexandre Pires",
    "Camila Castro", "Bruno Vieira", "Vit√≥ria Santos", "Diego Fernandes", "Giovanna Barbosa",
    "Enzo Rodrigues", "Helena Dias", "Ricardo Melo", "Aline Freitas", "Vinicius Correia",
    "Clara Azevedo", "Murilo Bernardes", "Emanuelly Dantas", "Heitor Campos", "L√≠via Miranda",
    "Gustavo Mendes", "Lorena Teixeira", "Ot√°vio Farias", "Yasmin Cavalcanti", "Arthur Lins",
    "Valentina Soares", "Samuel Magalh√£es", "Alice Sales", "Cau√£ Morais", "Rebeca Fonseca",
    "C√©sar Dutra", "Mirella Queiroz", "Ben√≠cio Guedes", "Let√≠cia Pimentel", "David Zambotti"
];

// Vari√°vel para armazenar o √≠ndice do pr√≥ximo nome a ser usado
// Tenta buscar o √≠ndice salvo no localStorage (para que n√£o repita o nome ao recarregar)
let currentNameIndex = parseInt(localStorage.getItem('currentNameIndex')) || 0;


// --- FUN√á√ïES DE PROVA SOCIAL ---

function showSocialProof() {
    // 1. Obter o pr√≥ximo nome (e garantir o loop)
    const purchaserName = SOCIAL_PROOF_NAMES[currentNameIndex % SOCIAL_PROOF_NAMES.length];
    
    // 2. Atualizar o √≠ndice para a pr√≥xima rodada (e salvar no localStorage)
    currentNameIndex++;
    if (currentNameIndex >= SOCIAL_PROOF_NAMES.length) {
        currentNameIndex = 0; // Volta para 0 se atingir o final da lista
    }
    localStorage.setItem('currentNameIndex', currentNameIndex.toString());
    
    // 3. Criar a mensagem
    const message = document.createElement('div');
    message.className = 'notification-message';
    message.innerHTML = `‚úÖ <strong>${purchaserName}</strong> acabou de comprar Holograma`;

    // 4. Adicionar e Mostrar (com pequeno delay para a transi√ß√£o funcionar)
    socialProofContainer.appendChild(message);

    setTimeout(() => {
        message.classList.add('show');
    }, 50);

    // 5. Esconder e Remover (dura√ß√£o de 4 segundos)
    setTimeout(() => {
        message.classList.remove('show');
        
        // Remove completamente ap√≥s a transi√ß√£o (0.5s definido no CSS)
        setTimeout(() => {
            message.remove();
        }, 500); 
    }, 4000); // Mensagem dura 4 segundos
}

function startSocialProofCycle() {
    // A primeira mensagem aparece ap√≥s 1 segundo
    setTimeout(showSocialProof, 1000); 

    // As mensagens seguintes aparecem a cada 6 segundos (6000ms)
    setInterval(showSocialProof, 6000); 
}


// --- FUN√á√ïES DE TIMER (Contagem regressiva) ---

function formatTime(seconds) {
    const min = String(Math.floor(seconds / 60)).padStart(2, '0');
    const sec = String(seconds % 60).padStart(2, '0');
    return `${min}:${sec}`;
}

let timerInterval;

function startTimer() {
    let timeLeft = TIMER_START_SECONDS;
    timerDisplay.textContent = formatTime(timeLeft);

    timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = formatTime(timeLeft);

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerDisplay.textContent = 'TEMPO ESGOTADO!';
        }
    }, 1000);
}

// --- FUN√á√ïES DE L√ìGICA TELA 1 (Cupom e Pre√ßo) ---

function updatePriceDisplay() {
    // Adiciona "R$" e formata para v√≠rgula
    priceIndicator.textContent = `Pre√ßo: R$${currentProductPrice.toFixed(2).replace('.', ',')}`;
}

applyCouponBtn.addEventListener('click', function() {
    const input = couponInput.value.trim();
    const messageElement = couponMessage;
    
    if (input.toUpperCase() === CORRECT_COUPON) { 
        currentProductPrice = INITIAL_PRODUCT_PRICE * (1 - DISCOUNT_PERCENTAGE);
        messageElement.textContent = `üéâ Cupom aceito! 30% de desconto aplicado. Pre√ßo: R$${currentProductPrice.toFixed(2).replace('.', ',')} üéâ`;
        messageElement.className = 'coupon-message success';
    } else {
        currentProductPrice = INITIAL_PRODUCT_PRICE;
        // Mensagem de erro corrigida e em min√∫sculas:
        messageElement.textContent = 'cupom incorreto.'; 
        messageElement.className = 'coupon-message incorrect'; 
    }
    updatePriceDisplay();
});


// --- FUN√á√ïES DE CONTROLE DE MODAL (Atualizadas) ---

function openModal(modal) {
    modal.style.display = 'block';
}

function updateAttentionModalContent(productType) {
    if (productType === 'VIP') {
        proofTitleElement.textContent = VIP_PROOF_VIDEO_TITLE;
        // N√£o usamos autoplay no modal de aten√ß√£o
        proofVideoIframe.src = `https://www.youtube.com/embed/${VIP_PROOF_VIDEO_ID}?autoplay=0&controls=1&modestbranding=1`; 
    } else { // HS
        proofTitleElement.textContent = HS_PROOF_VIDEO_TITLE;
        proofVideoIframe.src = `https://www.youtube.com/embed/${HS_PROOF_VIDEO_ID}?autoplay=0&controls=1&modestbranding=1`;
    }
}

function openAttentionModal(productType) {
    activeProduct = productType;
    updateAttentionModalContent(productType);
    attentionModal.style.display = 'block';
}

function closeModal(modal) {
    modal.style.display = 'none';
}

// Handler: Abre o Modal de Aten√ß√£o (Produto 1 - HS PESCO√áO)
startPurchaseBtn.addEventListener('click', () => {
    openAttentionModal('HS');
});

// Handler: Abre o Modal de Aten√ß√£o (Produto 2 - PAINEL VIP)
if (startVipPurchaseBtn) { 
    startVipPurchaseBtn.addEventListener('click', () => {
        openAttentionModal('VIP');
    });
}

// Handler: Fecha os Modals (Bot√£o X)
closeBtns.forEach(btn => btn.addEventListener('click', () => {
    closeModal(attentionModal);
    closeModal(durationModal);
}));

// Handler: Passa do Modal de Aten√ß√£o para o Modal de Dura√ß√£o
confirmModalBtn.addEventListener('click', () => {
    closeModal(attentionModal);
    openModal(durationModal);
    // Limpa a entrada e mensagem de erro ao abrir
    durationInput.value = '';
    durationValidationMessage.textContent = '';
    paymentStepContent.style.display = 'none';
});

// --- FUN√á√ïES DE L√ìGICA MODAL DURA√á√ÉO ---

durationInput.addEventListener('input', function() {
    // 1. Limitar a entrada a 2 d√≠gitos (ou 1 se for o caso)
    let value = this.value.replace(/\D/g, ''); // Remove n√£o-d√≠gitos
    if (value.length > 2) {
        value = value.slice(0, 2);
    }
    this.value = value;

    daysSelected = parseInt(value);

    // Esconde os detalhes do pagamento por padr√£o
    paymentStepContent.style.display = 'none';
    durationValidationMessage.textContent = '';
    durationValidationMessage.className = 'validation-message';

    if (isNaN(daysSelected) || daysSelected < 1) {
        // Nada selecionado ou inv√°lido, apenas retorna
        return;
    }

    if (daysSelected > 30) {
        durationValidationMessage.textContent = 'VOC√ä S√ì PODE ESCOLHER DE 1 A 30 DIAS';
        durationValidationMessage.className = 'validation-message incorrect';
        return;
    }
    
    // 2. C√°lculo do Pre√ßo
    finalPaymentPrice = DAY_PRICES[daysSelected];
    
    if (finalPaymentPrice) {
        const priceFormatted = finalPaymentPrice.toFixed(2).replace('.', ',');
        finalPriceElement.textContent = `R$${priceFormatted}`;
        durationValidationMessage.textContent = `‚úÖ ${daysSelected} dias selecionados. Pre√ßo: R$${priceFormatted}`;
        durationValidationMessage.className = 'validation-message success';
        
        // Exibe a se√ß√£o de pagamento
        paymentStepContent.style.display = 'block';
        
        // Reseta informa√ß√µes de pagamento
        copyFeedback.textContent = '';
        bankInfoDiv.style.display = 'none';
        openInstagramBtn.style.display = 'none';
        instagramInstructions.style.display = 'none';
    }
});

// For√ßar o teclado num√©rico em dispositivos m√≥veis (j√° feito com inputmode="numeric" no HTML, mas refor√ßando)
durationInput.addEventListener('focus', function() {
    this.setAttribute('inputmode', 'numeric');
});

// --- FUN√á√ïES DE L√ìGICA PAGAMENTO ---

// Handler: Copia a chave PIX
copyPixBtn.addEventListener('click', function() {
    if (finalPaymentPrice === 0) {
        copyFeedback.textContent = 'Selecione a dura√ß√£o antes de copiar.';
        copyFeedback.className = 'incorrect';
        return;
    }

    const priceFormatted = finalPaymentPrice.toFixed(2).replace('.', ',');
    
    // Copia a chave Pix
    navigator.clipboard.writeText(PIX_KEY)
        .then(() => {
            // Sucesso na c√≥pia
            copyFeedback.textContent = `‚úÖ Chave PIX copiada com sucesso! Valor: R$${priceFormatted}`;
            copyFeedback.className = 'success';
            
            // Mostra os detalhes do banco e o bot√£o Instagram
            bankInfoDiv.style.display = 'block';
            openInstagramBtn.style.display = 'block';
            instagramInstructions.style.display = 'block';
        })
        .catch(err => {
            // Falha na c√≥pia (fallback)
            console.error('Falha ao copiar:', err);
            copyFeedback.textContent = `Erro ao copiar (Copie manualmente): ${PIX_KEY}. Valor: R$${priceFormatted}`;
            copyFeedback.className = 'incorrect';
            bankInfoDiv.style.display = 'block'; // Mostra os dados mesmo com erro
        });
});

// Handler: Abre o Instagram no Direct com a mensagem pronta
openInstagramBtn.addEventListener('click', function() {
    window.open(INSTAGRAM_LINK_DIRECT, '_blank');
});

// --- FUN√á√ïES DE SCROLL (Para o Timer Fixo) ---

function handleScroll() {
    if (window.scrollY > 50) { // Se rolar mais de 50px
        countdownTimer.classList.add('scrolled-timer');
    } else {
        countdownTimer.classList.remove('scrolled-timer');
    }
}


// --- Inicializa√ß√£o ---

window.addEventListener('scroll', handleScroll);
startTimer(); 
updatePriceDisplay(); // Inicializa o display de pre√ßo
startSocialProofCycle(); // Inicia o ciclo de mensagens
